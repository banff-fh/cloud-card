<?xml version="1.0" encoding="UTF-8"?>
<entitymodel xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:noNamespaceSchemaLocation="http://ofbiz.apache.org/dtds/entitymodel.xsd">
    <!-- ========================================================= -->
    <!-- ======================== Defaults ======================= -->
    <!-- ========================================================= -->
    <title>Entity of cloudcard Component</title>
    <description>None</description>
    <copyright></copyright>
    <version></version>
	<view-entity entity-name="FinAccountAndPaymentMethodAndGiftCard" package-name="org.ofbiz.accounting.finaccount" title="cloud card info">
        <description>云卡视图（金融账户、金融账户角色、礼品卡关联）</description>
        <member-entity entity-alias="FA" entity-name="FinAccount"/>
        <member-entity entity-alias="FAR" entity-name="FinAccountRole"/>
        <member-entity entity-alias="PM" entity-name="PaymentMethod"/>
      	<member-entity entity-alias="GC" entity-name="GiftCard"/>
      	<alias entity-alias="FA" name="finAccountId" />
      	<alias entity-alias="FA" name="ownerPartyId" />
      	<alias entity-alias="FA" name="finAccountTypeId" />
      	<alias entity-alias="FA" name="statusId" />
      	<alias entity-alias="FA" name="finAccountName" />
      	<alias entity-alias="FA" name="organizationPartyId" />
      	<alias entity-alias="FA" name="finAccountCode" />
      	<alias entity-alias="FA" name="actualBalance" />
      	<alias entity-alias="FAR" name="distributorPartyId" field="partyId" />
		<alias entity-alias="PM" name="paymentMethodId" />
		<alias entity-alias="PM" name="paymentMethodTypeId" />
		<alias entity-alias="PM" name="partyId" />
		<alias entity-alias="PM" name="description" />
		<alias entity-alias="PM" name="fromDate" />
		<alias entity-alias="PM" name="thruDate" />
		<alias entity-alias="GC" name="cardNumber" />
		<alias entity-alias="GC" name="pinNumber" />
		<alias entity-alias="GC" name="expireDate" />
		<view-link entity-alias="FA" rel-entity-alias="FAR">
			<key-map field-name="finAccountId" rel-field-name="finAccountId" />
			<entity-condition>
				<condition-expr entity-alias="FAR" field-name="roleTypeId" operator="equals" value="DISTRIBUTOR"/>
			</entity-condition>
		</view-link>
		<view-link entity-alias="FA" rel-entity-alias="PM" rel-optional="true">
			<key-map field-name="finAccountId" rel-field-name="finAccountId" />
			<entity-condition>
				<condition-expr entity-alias="FA" field-name="finAccountTypeId" operator="equals" value="GIFTCERT_ACCOUNT"/>
			</entity-condition>
		</view-link>
		<view-link entity-alias="PM" rel-entity-alias="GC" rel-optional="true">
			<key-map field-name="paymentMethodId" />
		</view-link>
		<relation type="one-nofk" rel-entity-name="PaymentMethod">
			<key-map field-name="paymentMethodId" />
		</relation>
		<relation type="one-nofk" rel-entity-name="PaymentMethodType">
			<key-map field-name="paymentMethodTypeId" />
		</relation>
		<relation type="one-nofk" rel-entity-name="GiftCard">
			<key-map field-name="paymentMethodId" />
		</relation>
    </view-entity>
	
	
	<view-entity entity-name="TelecomNumberAndUserLogin"
        package-name="org.ofbiz.party.contact"
        title="根据会员电话号码查询userlogin">
        <member-entity entity-alias="PCMP" entity-name="PartyContactMechPurpose"/>
        <member-entity entity-alias="TN" entity-name="TelecomNumber"/>
        <member-entity entity-alias="PTY" entity-name="Party"/>
        <member-entity entity-alias="ULN" entity-name="UserLogin"/>
        <alias-all entity-alias="PCMP"/>
        <alias-all entity-alias="TN"/>
        <alias entity-alias="PTY" name="partyId"/>
        <alias entity-alias="PTY" name="partyTypeId"/>
        <alias entity-alias="ULN" name="userLoginId"/>
        <alias entity-alias="ULN" name="enabled"/>
        <view-link entity-alias="PCMP" rel-entity-alias="TN">
            <key-map field-name="contactMechId"/>
            <entity-condition>
                <condition-expr field-name="contactMechPurposeTypeId" operator="equals" value="AS_USER_LOGIN_ID"/>
            </entity-condition>
        </view-link>
        <view-link entity-alias="PCMP" rel-entity-alias="PTY">
            <key-map field-name="partyId"/>
        </view-link>
        <view-link entity-alias="PTY" rel-entity-alias="ULN">
            <key-map field-name="partyId"/>
        </view-link>
        <relation type="one-nofk" rel-entity-name="Party">
            <key-map field-name="partyId"/>
        </relation>
        <relation type="one-nofk" rel-entity-name="UserLogin">
            <key-map field-name="userLoginId"/>
        </relation>
    </view-entity>
    
    <entity entity-name="SmsValidateCode" package-name="org.ofbiz.cloudcard.sms" title="短信验证码">
		<description>短信验证码，过期的 且 isValid=Y 的数据都可以清理</description>
		<field name="teleNumber" type="id"></field>
		<field name="smsType" type="id"></field>
		<field name="captcha" type="id"></field>
		<field name="isValid" type="id"></field>
		<field name="fromDate" type="date-time"></field>
      	<field name="thruDate" type="date-time"></field>
      	<prim-key field="teleNumber"/>
      	<prim-key field="captcha"/>
	    <prim-key field="fromDate"/>
	</entity>
	
	<view-entity entity-name="CloudCardCrossStorePaymentView" package-name="org.ofbiz.cloudcard.payment" title="跨店流水">
        <description>
        	所有跨店消费的支付流水
        		即 支付所用的云卡的 发卡商家  与 支付的 party_id_to 不相等的记录
        </description>
      	<member-entity entity-alias="P" entity-name="Payment"/>
        <member-entity entity-alias="PM" entity-name="PaymentMethod"/>
        <member-entity entity-alias="FA" entity-name="FinAccount"/>
        <member-entity entity-alias="FAR" entity-name="FinAccountRole"/>
		<alias entity-alias="P" name="paymentId" />
		<alias entity-alias="P" name="paymentMethodTypeId" />
		<alias entity-alias="P" name="cardId" field="paymentMethodId" ><description>paymentMethodId即是云卡id</description></alias>
		<alias entity-alias="P" name="partyIdFrom" />
		<alias entity-alias="P" name="tradePartyId"  field="partyIdTo"><description>交易所在商家</description></alias>
		<alias entity-alias="P" name="effectiveDate" />
		<alias entity-alias="P" name="amount" />
		<alias entity-alias="P" name="currencyUomId" />
		<alias entity-alias="P" name="statusId" />
		<alias entity-alias="P" name="comments" />
		<alias entity-alias="PM" name="cardName"  field="description"/>
		<alias entity-alias="PM" name="customerPartyId" field="partyId"><description>持卡人、客户</description></alias>
		<alias entity-alias="FAR" name="distributorPartyId" field="partyId"><description>发行卡的商家</description></alias>
		
		<view-link entity-alias="P" rel-entity-alias="PM">
			<key-map field-name="paymentMethodId" />
			<entity-condition>
				<!-- 只查交易流水， paymentTypeId = GC_WITHDRAWAL -->
				<condition-expr field-name="paymentTypeId" operator="equals" value="GC_WITHDRAWAL"/>
			</entity-condition>
		</view-link>
		
		<view-link entity-alias="PM" rel-entity-alias="FA">
			<key-map field-name="finAccountId" />
		</view-link>
		
		<view-link entity-alias="FA" rel-entity-alias="FAR">
			<key-map field-name="finAccountId" rel-field-name="finAccountId" />
			<entity-condition>
				<condition-list combine="and">
					<condition-expr entity-alias="FAR" field-name="roleTypeId" operator="equals" value="DISTRIBUTOR"/>
					<condition-expr entity-alias="P" field-name="partyIdTo" operator="not-equals" rel-entity-alias="FAR" rel-field-name="partyId"/>
				</condition-list>
			</entity-condition>
		</view-link>
		<relation type="one-nofk" rel-entity-name="PaymentMethod">
			<key-map field-name="paymentMethodId" />
		</relation>
		<relation type="one-nofk" rel-entity-name="FinAccount">
			<key-map field-name="finAccountId" />
		</relation>
    </view-entity>
	
</entitymodel>